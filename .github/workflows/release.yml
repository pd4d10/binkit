# Release workflow - automatically publishes new versions to npm
# Triggered on push to main or manually via workflow_dispatch

name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      name:
        description: "Tool name to publish (skips check, for hotfixes)"
        required: true
        type: string
      upstream_version:
        description: "Upstream version to publish"
        required: true
        type: string

jobs:
  # Check which versions need to be published
  check:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}
      has_unpublished: ${{ steps.check.outputs.has_unpublished }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Check for unpublished versions
        id: check
        run: |
          # Manual trigger with inputs - skip check
          if [ -n "${{ inputs.name }}" ]; then
            echo "Manual publish: ${{ inputs.name }}@${{ inputs.upstream_version }}"
            echo "has_unpublished=true" >> $GITHUB_OUTPUT
            echo 'matrix={"include":[{"tool":"${{ inputs.name }}","upstreamVersion":"${{ inputs.upstream_version }}"}]}' >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto mode - check for unpublished versions
          OUTPUT=$(node cli/dist/cli.js check)
          echo "$OUTPUT"

          # Extract JSON from output
          JSON=$(echo "$OUTPUT" | grep "UNPUBLISHED_JSON=" | sed 's/UNPUBLISHED_JSON=//')

          if [ "$JSON" = "[]" ]; then
            echo "has_unpublished=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            echo "has_unpublished=true" >> $GITHUB_OUTPUT
            # Convert to matrix format
            MATRIX=$(echo "$JSON" | jq -c '{include: .}')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  # Build and publish target packages on each platform (must complete before main package)
  publish-targets:
    needs: check
    if: needs.check.outputs.has_unpublished == 'true'
    strategy:
      fail-fast: false
      matrix:
        target:
          - id: darwin-arm64
            os: macos-15
          - id: darwin-x64
            os: macos-15-intel
          - id: linux-x64
            os: ubuntu-24.04
          - id: linux-arm64
            os: ubuntu-24.04-arm
          - id: win32-x64
            os: windows-2025
    runs-on: ${{ matrix.target.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Generate and publish target packages
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          UNPUBLISHED: ${{ needs.check.outputs.matrix }}
        run: |
          # Parse the unpublished versions
          TOOLS=$(echo "$UNPUBLISHED" | jq -r '.include[] | "\(.tool):\(.upstreamVersion)"')

          for ENTRY in $TOOLS; do
            TOOL=$(echo "$ENTRY" | cut -d: -f1)
            VERSION=$(echo "$ENTRY" | cut -d: -f2)

            echo "Processing $TOOL@$VERSION for target ${{ matrix.target.id }}..."

            # Generate target package
            node cli/dist/cli.js target "$TOOL" "$VERSION" || true

            # Check if target package was generated
            TARGET_DIR="packages/${TOOL}-${{ matrix.target.id }}"
            if [ -d "$TARGET_DIR" ]; then
              echo "Publishing $TARGET_DIR..."
              cd "$TARGET_DIR"
              npm publish --access public || echo "Failed to publish, may already exist"
              cd ../..
            else
              echo "⚠️ Target ${{ matrix.target.id }} is not supported by $TOOL, skipping..."
            fi
          done

  # Publish main package after all target packages are published
  publish-main:
    needs: [check, publish-targets]
    if: needs.check.outputs.has_unpublished == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Generate main package
        run: |
          node cli/dist/cli.js main ${{ matrix.tool }} ${{ matrix.upstreamVersion }}

      - name: Publish main package
        run: |
          cd packages/${{ matrix.tool }}
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
